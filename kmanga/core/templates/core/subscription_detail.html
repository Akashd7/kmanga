{% extends "base.html" %}
{% load kmanga %}
{% load thumbnail %}

{% block page_title %}{{ object.manga.name }} <a href="{{ object.manga.url }}" class="label label-default">{{ object.manga.source.name }}</a>{% endblock page_title %}
{% block content %}
<div class="row">
  <div class="col-xs-4">
    <div class="thumbnail">
      <img src="{{ object.manga.cover|default:'default_cover.png'|thumbnail_url:'cover' }}" alt="{{ manga }}" height="360" width="270">
    </div>
  </div>
  <div class="col-xs-8">
    <h3>Description</h3>
    <p>{{ object.manga.description }}</p>
  </div>
</div>
<div class="row">
  <div class="col-xs-8">
    <h3>Issues</h3>
    <table class="table table-hover">
      <caption>List of issues in {{ object.get_language_display }}</caption>
      <thead>
	<tr>
	  <th>number</th>
	  <th>name</th>
	  <th>sent</th>
	  <th>resend</th>
	</tr>
      </thead>
      <tbody>
	{% for issue in object.issues %}
	<tr>
	  <th scope="row">{{ issue.number }}</th>
	  <td><a href="{{ issue.url }}">{{ issue.name }}</a></td>
	  {% with result=object|result:issue %}
	  <td>{{ result.modified|date:"d/m/Y" }}</td>
	  <td>
	    {% if not result %}
	    <form method="post" action="{% url 'result-create' %}">{% csrf_token %}
	      <input type="hidden" name="issue" value="{{ issue.pk }}">
	      <input type="hidden" name="subscription" value="{{ object.pk }}">
	      <input type="hidden" name="status" value="{{ 'SE' }}">
	      <button type="submit" class="btn btn-default">
		<span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> pending
	      </button>
	    </form>
	    {% elif result.is_pending %}
	    <form method="post" action="{% url 'result-update' result.pk %}">{% csrf_token %}
	      <input type="hidden" name="status" value="{{ result.SENT }}">
	      <button type="submit" class="btn btn-default">
		<span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> pending
	      </button>
	    </form>
	    {% elif result.is_processing %}
	    <form method="post" action="{% url 'result-update' result.pk %}">{% csrf_token %}
	      <input type="hidden" name="status" value="{{ result.PENDING }}">
	      <button type="submit" class="btn btn-warning">
		<span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> processing
	      </button>
	    </form>
	    {% elif result.is_sent %}
	    <form method="post" action="{% url 'result-update' result.pk %}">{% csrf_token %}
	      <input type="hidden" name="status" value="{{ result.PENDING }}">
	      <button type="submit" class="btn btn-success">
		<span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> sent
	      </button>
	    </form>
	    {% elif result.is_failed %}
	    <form method="post" action="{% url 'result-update' result.pk %}">{% csrf_token %}
	      <input type="hidden" name="status" value="{{ result.PENDING }}">
	      <button type="submit" class="btn btn-danger">
		<span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> failed
	      </button>
	    </form>
	    {% endif %}
	  </td>
	  {% endwith %}
	</tr>
	{% endfor %}
      </tbody>
    </table>
  </div>
  <div class="col-xs-4">
    <form method="post" action="{% url 'subscription-update' object.pk %}">{% csrf_token %}
      <div class="form-group">
	<label for="issues_per_day">Issues per day</label>
	<input id="issues_per_day" name="issues_per_day" class="form-control" value="{{ object.issues_per_day }}">
      </div>
      <div class="checkbox">
	<label>
	  <input name="paused" type="checkbox" {% if object.paused %}checked="checked"{% endif %}> Pause
	</label>
      </div>
      <div class="form-group">
	<label for="language">Language</label>
	<select id="language" name="language" class="form-control">
	  {% for language in object.manga.languages %}
	  <option value="{{ language.language }}" {% if object.language == language.language %}selected="1"{% endif %}>{{ language.language }} ({{ language.language__count }} issues)</option>
	  {% endfor %}
	</select>
      </div>
      <button type="submit" class="btn btn-lg btn-default">Update</button>
    </form>
    <hr>
    <a href="{% url 'subscription-delete' object.pk %}" class="btn btn-lg btn-default" role="button"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Unsubscribe</a>
  </div>
</div>
{% endblock content %}
